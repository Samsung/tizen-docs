<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Tizen Native API: Eo Tutorial</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen_html_stylesheet.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Tizen Native API
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>The&#160;Basics&#160;of&#160;Tizen&#160;Native&#160;API&#160;Reference</span></a></li>
      <li><a href="modules.html"><span>Native&#160;API&#160;Reference</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Eo Tutorial </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="Purpose"></a>
Purpose</h2>
<p>The purpose of this document is to explain how to work with Eo, how to port your code to Eo and what are the common pitfalls. It doesn't explain how it works inside.</p>
<h2><a class="anchor" id="Description"></a>
Description</h2>
<p>Eo is an Object oriented infrastructure for the EFL. It is a API/ABI safe library.</p>
<p>It supports inheritance, mixins, interfaces and composite objects.<br/>
 Every class can implement functions from every other class.<br/>
 It supports event signals, function overrides, private/protected/public/etc. variables and functions.</p>
<p>At the creation of the class, a "virtual table" is filled with the needed functions.<br/>
 The key of this table is a (class id, function id) tuple.</p>
<p>eo_do() is invoked with a list of op ids and their parameters and is in charge to dispatch the relevant functions. Finding the correct function is fast because it is just a lookup table.</p>
<h2><a class="anchor" id="howto"></a>
How to use it?</h2>
<ul>
<li>Creation of an instance of a class</li>
</ul>
<ul>
<li>Old way: <div class="fragment"><pre class="fragment">   <span class="keywordtype">object</span> = evas_object_line_add(canvas);
</pre></div></li>
</ul>
<ul>
<li>Eo way: <div class="fragment"><pre class="fragment">   <span class="keywordtype">object</span> = eo_add(EVAS_OBJ_LINE_CLASS, canvas);
</pre></div></li>
</ul>
<ul>
<li>Call to function</li>
</ul>
<ul>
<li>Old way: <div class="fragment"><pre class="fragment">      <a class="code" href="group__Evas__Font__Group.html#ga02da8091bbac768b8e86c7b74b2a94f9">evas_object_move</a>(obj, 120, 120);
      <a class="code" href="group__Evas__Font__Group.html#ga21e8604c0e4a93e469bff4bd069e82b5">evas_object_resize</a>(obj, 200, 200);
</pre></div></li>
</ul>
<ul>
<li>Eo way: <div class="fragment"><pre class="fragment">      eo_do(obj,
            evas_obj_move(120, 120),
            evas_obj_resize(200, 200));
</pre></div></li>
</ul>
<ul>
<li>Extract specific data</li>
</ul>
<ul>
<li>Old way: <div class="fragment"><pre class="fragment">      Evas_Object_Line *o = (Evas_Object_Line *)(obj-&gt;object_data);
      MAGIC_CHECK(o, Evas_Object_Line, MAGIC_OBJ_LINE);
      <span class="keywordflow">return</span>;
      MAGIC_CHECK_END();
</pre></div></li>
</ul>
<ul>
<li>Eo way: Two functions can be used to extract object data. The use depends if you want to store the data or not. If you just need to access data in the function (most of the time), just use eo_data_scope_get. If you need to store the data (for example in a list of objects data), you have to use eo_data_ref. This function references the data. If you don't need the referenced data anymore, call eo_data_unref. This reference mechanism will be used in the future to detect bad usage of objects, defragment the memory space used by the objects... <div class="fragment"><pre class="fragment">      Evas_Object_Line *o = eo_data_scope_get(obj, EVAS_OBJ_LINE_CLASS);
      <span class="keywordflow">if</span> (!o) <span class="keywordflow">return</span>;
</pre></div> or <div class="fragment"><pre class="fragment">      Evas_Object_Line *o = eo_data_ref(obj, EVAS_OBJ_LINE_CLASS);
      <span class="keywordflow">if</span> (!o) <span class="keywordflow">return</span>;
      ...
      eo_data_unref(obj, o);
</pre></div></li>
</ul>
<ul>
<li>Call function of parent<ul>
<li>Old way: <div class="fragment"><pre class="fragment">      ELM_WIDGET_CLASS(_elm_button_parent_sc)-&gt;theme(obj));
</pre></div></li>
</ul>
</li>
</ul>
<ul>
<li>New way: <div class="fragment"><pre class="fragment">      eo_do_super(obj, elm_wdg_theme(&amp;int_ret));
</pre></div></li>
</ul>
<h2><a class="anchor" id="important"></a>
Important to know</h2>
<ul>
<li>eo_do() is the function used to invoke functions of a specific class on an object.</li>
</ul>
<ul>
<li>eo_data_scope_get() and eo_data_ref() receives an object and a class and returns the data of the given class for the object. The class must belong to the object class hierarchy.</li>
</ul>
<ul>
<li>eo_data_unref() receives an object and the data to unreference. The data MUST belong to this object.</li>
</ul>
<ul>
<li>eo_isa() indicates if a given object is of a given type.</li>
</ul>
<ul>
<li>eo_do_super() is in charge to invoke a function in the next parents that implement it. It is recommended to use eo_do_super() only from a function with the same op id.<br/>
 In addition, there is no way to jump over classes who implement the function. If A inherits from B, B from C and A, B and C implement a virtual function defined in C, the function calls order will be A, then B and finally C. It is impossible to pass over B.</li>
</ul>
<ul>
<li>eo_do() returns if the operation succeeded or failed (function found, object deleted...), not the result of the called function. Pay attention to this detail when you call eo_do(). The return value needs to be an additional parameter which will hold a return value.</li>
</ul>
<ul>
<li>Don't do this: <div class="fragment"><pre class="fragment">      <span class="keywordtype">int</span> w, h;
      eo_do(obj,
            evas_obj_size_get(&amp;w, &amp;h),
            evas_obj_size_set(w+10, h+20));
</pre></div> w+10 and h+20 are evaluated before the call to size_get. Instead, separate it in two calls to eo_do().</li>
</ul>
<ul>
<li>When creating an object with eo_add(), the reference counter of this one is incremented. If it is called with a parent, two references are on the object. eo_del() removes both of these references.<br/>
 When there is no more references on an object, this one is deleted and then can be freed. The deletion calls to the destructor (see eo_destructor()). When done, Eo checks if the object can be freed. The free mechanism can be "disabled" through eo_manual_free_set(). If this is the case, it is the responsibility of the developer to call eo_manual_free() on the object in order to free it. This mechanism has been used for example in <a class="el" href="group__Evas.html">Evas</a> on the Evas objects and in <a class="el" href="group__Ecore.html">Ecore</a>.</li>
</ul>
<ul>
<li>When eo_do() reaches a function of a class, it is the responsibility of the user to extract from the va_list ALL the parameters needed for this function, NO MORE, NO LESS. Otherwise, unknown behavior can occur. eo_do() is called with a list of op id, params, op id, params... A bad extraction of parameters can bring to the parsing of a wrong op id and so in the best case, to an error, in the worst case, to another function not in relation with the actual use case.</li>
</ul>
<ul>
<li>Always pay attention to:<ul>
<li>the pairing between function id and the function itself. Using the same function for two ids occurs and is hard to debug.</li>
<li>the definition of the function macros in the H file and their parameters order/type</li>
<li>to extract all the parameters of a function from the va_list</li>
</ul>
</li>
</ul>
<ul>
<li>Enum of the op ids in H file and descriptions in C file must be synchronized, i.e same number of ids and same order. If you change the order by adding, removing or moving ids, you break ABI of your library.</li>
</ul>
<ul>
<li>Avoid exposing your class data to prevent ABI break. Supply access functions instead.</li>
</ul>
<h2><a class="anchor" id="create_class_h_side"></a>
How to create a class - H side?</h2>
<ul>
<li>If the object is new, establish the public APIs</li>
<li>#define $(CLASS_NAME) $(class_name)_class_get(): will be used to access data/inherit from this class...</li>
<li>const Eo_Class *$(class_name)_class_get(void) EINA_CONST: declaration of the function that will create the class (not the instance), i.e virtual table...</li>
<li>extern EAPI Eo_Op $(CLASS_NAME)_BASE_ID: class id that will be essentially used to identify functions set of this class</li>
<li>enum of the function ids of the class in the form $(CLASS_NAME)_SUB_ID: used to identify the function inside the class; function id is unique per class but (class id, function id) is unique per system..</li>
<li>#define $(CLASS_NAME)_ID(sub_id) ($(CLASS_NAME)_BASE_ID + sub_id): formula to calculate the system function id</li>
<li>define of each function consists of:<ul>
<li>the name of the function that will be used in eo_do</li>
<li>parameters without types</li>
<li>$(CLASS_NAME)_ID($(CLASS_NAME)_SUB_ID_FUNCTION</li>
<li>EO_TYPECHECK for each parameter: type and variable name</li>
</ul>
</li>
<li>And don't forget to document each function</li>
</ul>
<ul>
<li>Example (Evas Object Line): <div class="fragment"><pre class="fragment"><span class="preprocessor">   #define EVAS_OBJ_LINE_CLASS evas_object_line_class_get()</span>
<span class="preprocessor"></span>
   <span class="keyword">const</span> Eo_Class *evas_object_line_class_get(<span class="keywordtype">void</span>) <a class="code" href="group__Eina__Types__Group.html#ga04f4a207fcde054c818bace8af77dcd6" title="Attribute from gcc to prevent the function to read/modify any global memory.">EINA_CONST</a>;

   extern <a class="code" href="group__Eina__Types__Group.html#ga3db3556eec8ef18cb8ddb43816974ac8" title="Used to export functions(by changing visibility).">EAPI</a> Eo_Op EVAS_OBJ_LINE_BASE_ID;

   enum
   {
      EVAS_OBJ_LINE_SUB_ID_XY_SET,
      EVAS_OBJ_LINE_SUB_ID_XY_GET,
      EVAS_OBJ_LINE_SUB_ID_LAST
   }

<span class="preprocessor">   #define EVAS_OBJ_LINE_ID(sub_id) (EVAS_OBJ_LINE_BASE_ID + sub_id)</span>
<span class="preprocessor"></span>
   <span class="comment">/*</span>
<span class="comment"> @def evas_obj_line_xy_set</span>
<span class="comment"> @since 1.8</span>
<span class="comment"></span>
<span class="comment"> Sets the coordinates of the end points of the given evas line object.</span>
<span class="comment"></span>
<span class="comment"> @param[in] x1</span>
<span class="comment"> @param[in] y1</span>
<span class="comment"> @param[in] x2</span>
<span class="comment"> @param[in] y2</span>
<span class="comment"></span>
<span class="comment">    */</span>
<span class="preprocessor">   #define evas_obj_line_xy_set(x1, y1, x2, y2) EVAS_OBJ_LINE_ID(EVAS_OBJ_LINE_SUB_ID_XY_SET), EO_TYPECHECK(Evas_Coord, x1), EO_TYPECHECK(Evas_Coord, y1), EO_TYPECHECK(Evas_Coord, x2), EO_TYPECHECK(Evas_Coord, y2)</span>
<span class="preprocessor"></span>
   <span class="comment">/*</span>
<span class="comment"> @def evas_obj_line_xy_get</span>
<span class="comment"> @since 1.8</span>
<span class="comment"></span>
<span class="comment"> Retrieves the coordinates of the end points of the given evas line object.</span>
<span class="comment"></span>
<span class="comment"> @param[out] x1</span>
<span class="comment"> @param[out] y1</span>
<span class="comment"> @param[out] x2</span>
<span class="comment"> @param[out] y2</span>
<span class="comment"></span>
<span class="comment">    */</span>
<span class="preprocessor">   #define evas_obj_line_xy_get(x1, y1, x2, y2) EVAS_OBJ_LINE_ID(EVAS_OBJ_LINE_SUB_ID_XY_GET), EO_TYPECHECK(Evas_Coord *, x1), EO_TYPECHECK(Evas_Coord *, y1), EO_TYPECHECK(Evas_Coord *, x2), EO_TYPECHECK(Evas_Coord *, y2)</span>
</pre></div></li>
</ul>
<h2><a class="anchor" id="create_class_c_size"></a>
How to create a class - C side?</h2>
<p>Below, the object line as example.</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">   #include &quot;Eo.h&quot;</span>\n
   <a class="code" href="group__Eina__Types__Group.html#ga3db3556eec8ef18cb8ddb43816974ac8" title="Used to export functions(by changing visibility).">EAPI</a> Eo_Op \$(CLASS_NAME)_BASE_ID = EO_NOOP; <span class="comment">// Initialisation of the class id to 0. Will be set dynamically by Eo itself.\n</span>
<span class="preprocessor">   #define MY_CLASS \$(CLASS_NAME)</span>
<span class="preprocessor"></span>
   ...
</pre></div><p>Example for a developer function called by Eo:<br/>
 This function receives the Eo object, the data corresponding to this class and the list of parameters. </p>
<div class="fragment"><pre class="fragment">   <span class="keyword">static</span> <span class="keywordtype">void</span>
   _foo(Eo *eo_obj, <span class="keywordtype">void</span> *_pd, va_list *list)
   {
      <span class="keywordtype">int</span> param_1 = va_arg(*list, <span class="keywordtype">int</span>);
      <a class="code" href="group__Eina__Types__Group.html#ga3fe0caf72e93b1bab1ca8ee3ccf3f226">Eina_Bool</a> param_2 = va_arg(*list, <span class="keywordtype">int</span>);
      <a class="code" href="group__Eina__Types__Group.html#ga3fe0caf72e93b1bab1ca8ee3ccf3f226">Eina_Bool</a> ret = va_arg(*list, <a class="code" href="group__Eina__Types__Group.html#ga3fe0caf72e93b1bab1ca8ee3ccf3f226">Eina_Bool</a> *);
      foo_data obj = _pd;

      <span class="keywordflow">if</span> (ret) *ret = <a class="code" href="group__Eina__Types__Group.html#ga1feb115f8e9913e806e090d9bd5a7301">EINA_FALSE</a>;
      ...
   }
</pre></div><p>You can (not a must) implement a constructor. This constructor MUST call the parent constructor (eo_do_super()). It is the same for the destructor.<br/>
 See eo_constructor() and eo_destructor().<br/>
 If you don't have anything to do in constructor (like malloc, variables init...) or in destructor (free), don't implement them.</p>
<p>At the end of the file, you need to describe the class.<br/>
 First, you need to supply the class constructor that sets the list of the functions that are implemented in this class. It includes functions overriden (constructor, destructor, member_add...) and functions specific to this class. If there is no function implemented in this class, you don't need a class constructor.<br/>
 Then, you need a list to describe the new functions. For each one, the op id and a description.<br/>
</p>
<p>Then, the class itself that consists in:</p>
<ul>
<li>the version of Eo, used for backward compatibility</li>
<li>the class name</li>
<li>the type of the class:<ul>
<li>regular: an object can be created from this type (mostly used)</li>
<li>regular non instant-iable: Same as previous, but objects can’t be created from this type (elm_widget)</li>
<li>interface: used to extend classes, no implementations for functions and no internal data</li>
<li>mixin : interfaces with internal data and pre-made implementations for functions</li>
</ul>
</li>
<li>the descriptions list described above and the number of ops for this class</li>
<li>events</li>
<li>size of the data of the class</li>
<li>the class constructor, if exists, else NULL</li>
<li>the class destructor (NULL most of the time)</li>
</ul>
<p>Finally, we define the class with:</p>
<ul>
<li>the function name to give to the function that creates/returns the class</li>
<li>the class description explained above</li>
<li>the parent and the interfaces/mixins, finished by NULL</li>
</ul>
<p>Example (Evas Object Line): </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">   #include &quot;Eo.h&quot;</span>

   <a class="code" href="group__Eina__Types__Group.html#ga3db3556eec8ef18cb8ddb43816974ac8" title="Used to export functions(by changing visibility).">EAPI</a> Eo_Op EVAS_OBJ_LINE_BASE_ID = EO_NOOP;

<span class="preprocessor">   #define MY_CLASS EVAS_OBJ_LINE_CLASS</span>
</pre></div><p>...</p>
<div class="fragment"><pre class="fragment">   <span class="keyword">static</span> <span class="keywordtype">void</span>
   _line_xy_get(Eo *eo_obj, <span class="keywordtype">void</span> *_pd, va_list *list)
   {
      <span class="keyword">const</span> Evas_Object_Line *o = _pd;

      <a class="code" href="group__Evas.html#ga2453e92182bad3b0e0d84e5aff433b07">Evas_Coord</a> *x1 = va_arg(*list, <a class="code" href="group__Evas.html#ga2453e92182bad3b0e0d84e5aff433b07">Evas_Coord</a> *);
      <a class="code" href="group__Evas.html#ga2453e92182bad3b0e0d84e5aff433b07">Evas_Coord</a> *y1 = va_arg(*list, <a class="code" href="group__Evas.html#ga2453e92182bad3b0e0d84e5aff433b07">Evas_Coord</a> *);
      <a class="code" href="group__Evas.html#ga2453e92182bad3b0e0d84e5aff433b07">Evas_Coord</a> *x2 = va_arg(*list, <a class="code" href="group__Evas.html#ga2453e92182bad3b0e0d84e5aff433b07">Evas_Coord</a> *);
      <a class="code" href="group__Evas.html#ga2453e92182bad3b0e0d84e5aff433b07">Evas_Coord</a> *y2 = va_arg(*list, <a class="code" href="group__Evas.html#ga2453e92182bad3b0e0d84e5aff433b07">Evas_Coord</a> *);

      Evas_Object_Protected_Data *obj = eo_data_scope_get(eo_obj, EVAS_OBJ_CLASS);
      <span class="keywordflow">if</span> (x1) *x1 = obj-&gt;cur.geometry.x + o-&gt;cur.x1;
      <span class="keywordflow">if</span> (y1) *y1 = obj-&gt;cur.geometry.y + o-&gt;cur.y1;
      <span class="keywordflow">if</span> (x2) *x2 = obj-&gt;cur.geometry.x + o-&gt;cur.x2;
      <span class="keywordflow">if</span> (y2) *y2 = obj-&gt;cur.geometry.y + o-&gt;cur.y2;
   }

   <span class="keyword">static</span> <span class="keywordtype">void</span>
   _constructor(Eo *eo_obj, <span class="keywordtype">void</span> *class_data, va_list *list EINA_UNUSED)
   {
      eo_do_super(eo_obj, eo_constructor());

      Evas_Object_Protected_Data *obj = eo_data_scope_get(eo_obj, EVAS_OBJ_CLASS);
      evas_object_line_init(eo_obj);
   }

   ...

   <span class="comment">/* class constructor */</span>
   <span class="keyword">static</span> <span class="keywordtype">void</span>
   _class_constructor(Eo_Class *klass)
   {
      <span class="keyword">const</span> Eo_Op_Func_Description func_desc[] = {
           <span class="comment">/* Virtual functions of parent class implemented in this class */</span>
           EO_OP_FUNC(EO_BASE_ID(EO_BASE_SUB_ID_CONSTRUCTOR), _constructor),
           EO_OP_FUNC(EO_BASE_ID(EO_BASE_SUB_ID_DESTRUCTOR), _destructor),
           <span class="comment">/* Specific functions to this class */</span>
           EO_OP_FUNC(EVAS_OBJ_LINE_ID(EVAS_OBJ_LINE_SUB_ID_XY_SET), _line_xy_set),
           EO_OP_FUNC(EVAS_OBJ_LINE_ID(EVAS_OBJ_LINE_SUB_ID_XY_GET), _line_xy_get),
           EO_OP_FUNC_SENTINEL
      };

      eo_class_funcs_set(klass, func_desc);
   }

   <span class="comment">/* Descriptions for the functions specific to this class */</span>
   <span class="keyword">static</span> <span class="keyword">const</span> Eo_Op_Description op_desc[] = {
        EO_OP_DESCRIPTION(EVAS_OBJ_LINE_SUB_ID_XY_SET, <span class="stringliteral">&quot;Sets the coordinates of the end points of the given evas line object.&quot;</span>),
        EO_OP_DESCRIPTION(EVAS_OBJ_LINE_SUB_ID_XY_GET, <span class="stringliteral">&quot;Retrieves the coordinates of the end points of the given evas line object.&quot;</span>),
        EO_OP_DESCRIPTION_SENTINEL
   };

   <span class="comment">/* Description of the class */</span>
   <span class="keyword">static</span> <span class="keyword">const</span> Eo_Class_Description class_desc = {
        EO_VERSION,
        <span class="stringliteral">&quot;Evas_Object_Line&quot;</span>,
        EO_CLASS_TYPE_REGULAR,
        EO_CLASS_DESCRIPTION_OPS(&amp;EVAS_OBJ_LINE_BASE_ID, op_desc, EVAS_OBJ_LINE_SUB_ID_LAST),
        NULL,
        <span class="keyword">sizeof</span>(Evas_Object_Line),
        _class_constructor,
        NULL
   };

   <span class="comment">/* Definition of the class */</span>
   EO_DEFINE_CLASS(evas_object_line_class_get, &amp;class_desc, EVAS_OBJ_CLASS, NULL);
</pre></div> </div></div><!-- contents -->
<hr size="1"/>
<center>
<small>Except as noted, this content - excluding the Code Examples - is licensed under <a href="http://creativecommons.org/licenses/by/3.0/legalcode" target="_blank">Creative Commons Attribution 3.0</a>
and all of the Code Examples contained herein are licensed under <a href="https://www.tizen.org/bsd-3-clause-license" target="_blank">BSD-3-Clause</a>.<br/>For details, see the <a href="https://www.tizen.org/content-license" target="_blank">Content License</a>.&nbsp;</small>
</center>
</body>
</html>
