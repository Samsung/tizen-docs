<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Tizen Native API: EFL Threading example 6</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen_html_stylesheet.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
</script>
<link rel="search" href="search-opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Tizen Native API"/>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Tizen Native API
   &#160;<span id="projectnumber">5.5</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>The&#160;Basics&#160;of&#160;Tizen&#160;Native&#160;API&#160;Reference</span></a></li>
      <li><a href="modules.html"><span>Native&#160;API&#160;Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.php" method="get">
              <img id="MSearchSelect" src="search/mag.png" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
      </li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('efl_thread_6.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">EFL Threading example 6 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>You can also use the ecore_thread infrastructure for compute tasks that don't send feedback as they go - they are one-shot compute jobs and when done they will trigger the end callback in the mainloop which is intended to pick up the results and "display them".</p>
<div class="fragment"><pre class="fragment"><span class="comment">//Compile with:</span>
<span class="comment">//gcc -o efl_thread_6 efl_thread_6.c -g `pkg-config --cflags --libs elementary`</span>
<span class="preprocessor">#include &lt;Elementary.h&gt;</span>

<span class="keyword">static</span> <a class="code" href="group__Evas__Object__Group.html#ga9e19e6dd1f517a0ba437c0114d3e7c97">Evas_Object</a> *win = NULL;
<span class="keyword">static</span> <a class="code" href="struct__Eina__List.html">Eina_List</a> *threads;

<span class="keyword">struct </span>info
{
   <a class="code" href="group__Evas__Object__Group.html#ga9e19e6dd1f517a0ba437c0114d3e7c97">Evas_Object</a> *obj;
   <span class="keywordtype">int</span> *pix;
};

<span class="comment">// BEGIN - code running in my custom thread instance</span>
<span class="comment">//</span>
<span class="keyword">static</span> <span class="keywordtype">void</span>
mandel(<a class="code" href="group__Ecore__Thread__Group.html#ga0c2e1f8d562ccf80ecc0009ada72496f">Ecore_Thread</a> *th, <span class="keywordtype">int</span> *pix, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h)
{
   <span class="keywordtype">double</span> x, xx, y, cx, cy, cox, coy;
   <span class="keywordtype">int</span> iteration, hx, hy, val, r, g, b, rr, gg, bb;
   <span class="keywordtype">int</span> itermax = 10000;
   <span class="keywordtype">double</span> magnify = 0.02;

   <span class="comment">// this mandel calc is run in the worker threads so it&#39;s here. it is</span>
   <span class="comment">// just here to calculate something and consume cpu to demonstrate the</span>
   <span class="comment">// ecore thread worker queue. don&#39;t pay much attention to the below code</span>
   magnify += ((double)(rand() % 100) / 100.0) / 4.0;
   cox = (double)(rand() % 100) / 100.0;
   coy = (double)(rand() % 100) / 100.0;
   cox /= (magnify * 3.0);
   r = rand() % 255; g = rand() % 255; b = rand() % 255;
   <span class="keywordflow">for</span> (hy = 0; hy &lt; h; hy++)
     {
        <span class="comment">// every line check if thread has been cancelled to return early</span>
        <span class="keywordflow">if</span> (<a class="code" href="group__Ecore__Thread__Group.html#ga792471a7ed00718b71d58b791ddbd08d">ecore_thread_check</a>(th)) <span class="keywordflow">return</span>;
        <span class="keywordflow">for</span> (hx = 0; hx &lt; w; hx++)
          {
             cx = (((float)hx) / ((float)w) - 0.5) / (magnify * 3.0);
             cy = (((float)hy) / ((float)h) - 0.5) / (magnify * 3.0);
             cx += cox;
             cy += coy;
             x = 0.0;
             y = 0.0;
             <span class="keywordflow">for</span> (iteration = 1; iteration &lt; itermax; iteration++)
               {
                  xx = (x * x) - (y * y) + cx;
                  y = (2.0 * x * y) + cy;
                  x = xx;
                  <span class="keywordflow">if</span> (((x * x) + (y * y)) &gt; 100.0) iteration = 999999;
               }
             val = (((x * x) + (y * y)) * 2.55) / 100.0;
             <span class="keywordflow">if</span> (val &gt; 255) val = 255;
             <span class="keywordflow">if</span> (iteration &gt;= 99999)
               {
                  rr = (r * val) / 255;
                  gg = (g * val) / 255;
                  bb = (b * val) / 255;
                  pix[(hy * w) + hx] =
                     (val  &lt;&lt; 24) | (rr &lt;&lt; 16) | (gg &lt;&lt; 8) | (bb);
               }
             <span class="keywordflow">else</span>
               pix[(hy * w) + hx] = 0xffffffff;
          }
     }
}

<span class="keyword">static</span> <span class="keywordtype">void</span>
th_do(<span class="keywordtype">void</span> *data, <a class="code" href="group__Ecore__Thread__Group.html#ga0c2e1f8d562ccf80ecc0009ada72496f">Ecore_Thread</a> *th)
{
   <span class="keyword">struct </span>info *inf = data;
   <span class="comment">// CANNOT TOUCH inf-&gt;obj here! just inf-&gt;pix which is 256x256 @ 32bpp</span>
   <span class="comment">// quick and dirty to consume some cpu - do a mandelbrot calc</span>
   mandel(th, inf-&gt;pix, 256, 256);
}
<span class="comment">//</span>
<span class="comment">// END - code running in my custom thread instance</span>

<span class="keyword">static</span> <span class="keywordtype">void</span> <span class="comment">// thread job finished - collect results and put in img obj</span>
th_end(<span class="keywordtype">void</span> *data, <a class="code" href="group__Ecore__Thread__Group.html#ga0c2e1f8d562ccf80ecc0009ada72496f">Ecore_Thread</a> *th)
{
   <span class="keyword">struct </span>info *inf = data;

   <span class="comment">// copy data to object, free calculated data and info struc</span>
   evas_object_image_data_copy_set(inf-&gt;obj, inf-&gt;pix);
   <a class="code" href="group__Evas__Object__Group__Basic.html#ga9cbc13661584e49fb9d9cdab514a1eeb">evas_object_show</a>(inf-&gt;obj);
   free(inf-&gt;pix);
   free(inf);
   threads = <a class="code" href="group__Eina__List__Group.html#ga7c0c6e07aa592a1cb2e010049a718035" title="Removes the first instance of the specified data from the given list.">eina_list_remove</a>(threads, th);
}

<span class="keyword">static</span> <span class="keywordtype">void</span> <span class="comment">// if the thread is cancelled - free pix, keep obj tho</span>
th_cancel(<span class="keywordtype">void</span> *data, <a class="code" href="group__Ecore__Thread__Group.html#ga0c2e1f8d562ccf80ecc0009ada72496f">Ecore_Thread</a> *th EINA_UNUSED)
{
   <span class="keyword">struct </span>info *inf = data;

   <span class="comment">// just free pixel data and info struct</span>
   free(inf-&gt;pix);
   free(inf);
}

<span class="keyword">static</span> <a class="code" href="group__Eina__Types__Group.html#ga3fe0caf72e93b1bab1ca8ee3ccf3f226">Eina_Bool</a> <span class="comment">// animate the objects so you see all the madels move</span>
anim(<span class="keywordtype">void</span> *data)
{
   <a class="code" href="group__Evas__Object__Group.html#ga9e19e6dd1f517a0ba437c0114d3e7c97">Evas_Object</a> *o = data;
   <span class="keywordtype">double</span> t, z;
   <span class="keywordtype">int</span> w, h, v;
   Evas_Coord x, y;

   <span class="comment">// just calculate some position using the pointer value of the object as</span>
   <span class="comment">// a seed value to make different objects go into different places over time</span>
   v = ((int)(uintptr_t)o) &amp; 0xff;
   t = <a class="code" href="group__Ecore__Time__Group.html#gab53d952cc4c2f3ed032d535b307c43bd">ecore_loop_time_get</a>();
   w = 100 + ((v * 100) &gt;&gt; 8);
   h = 100 + ((v * 100) &gt;&gt; 8);
   z = (double)(v) / 100.0;
   x = (w * sin(t));
   y = (h * cos(t + z));
   <span class="comment">// do the actual move</span>
   evas_object_move(o, 200 + x - 128, 200 + y - 128);
   <span class="comment">// keep looping - return true</span>
   <span class="keywordflow">return</span> <a class="code" href="group__Eina__Types__Group.html#ga05c12dacc8b4058994df842b41be85fc">EINA_TRUE</a>;
}

EAPI_MAIN <span class="keywordtype">int</span>
elm_main(<span class="keywordtype">int</span> argc EINA_UNUSED, <span class="keywordtype">char</span> **argv EINA_UNUSED)
{
   <a class="code" href="group__Evas__Object__Group.html#ga9e19e6dd1f517a0ba437c0114d3e7c97">Evas_Object</a> *o;
   <a class="code" href="group__Ecore__Thread__Group.html#ga0c2e1f8d562ccf80ecc0009ada72496f">Ecore_Thread</a> *th;
   <span class="keywordtype">int</span> i;

   <a class="code" href="group__Elm__General.html#ga7a05f37fd3a019da5e26c5fc91fcd937">elm_policy_set</a>(<a class="code" href="group__Elm__General.html#ggaa16f3378ecdbf660fa378402e3c5a0a9a02fadb6faada04b19d0fa42c11a8d32a">ELM_POLICY_QUIT</a>, <a class="code" href="group__Elm__General.html#gga46af37e6ac2c406321060be827117196abbe0962d88ae12afe1a173da881f56cd">ELM_POLICY_QUIT_LAST_WINDOW_CLOSED</a>);

   win = <a class="code" href="group__Elm__Win.html#gac75d7752662fab73d6420706ce5be996">elm_win_util_standard_add</a>(<span class="stringliteral">&quot;efl-thread-6&quot;</span>, <span class="stringliteral">&quot;EFL Thread 6&quot;</span>);
   <a class="code" href="group__Elm__Win.html#ga9a16a2f8c9fd5b6e9203ed9dcb53ea8b" title="Sets the window&#39;s autodel state.">elm_win_autodel_set</a>(win, <a class="code" href="group__Eina__Types__Group.html#ga05c12dacc8b4058994df842b41be85fc">EINA_TRUE</a>);

   <span class="comment">// queue up 64 mandel generation thread jobs</span>
   <span class="keywordflow">for</span> (i = 0; i &lt; 64; i++)
     {
        <span class="keyword">struct </span>info *inf;

        <span class="comment">// create ecore thread to do some threaded job inside the worker pool</span>
        inf = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> info));
        <span class="keywordflow">if</span> (inf)
          {
             o = evas_object_image_filled_add(evas_object_evas_get(win));
             evas_object_image_size_set(o, 256, 256);
             evas_object_image_alpha_set(o, <a class="code" href="group__Eina__Types__Group.html#ga05c12dacc8b4058994df842b41be85fc">EINA_TRUE</a>);
             evas_object_resize(o, 256, 256);
             inf-&gt;obj = o;
             inf-&gt;pix = malloc(256 * 256 * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
             th = <a class="code" href="group__Ecore__Thread__Group.html#gaac9c9933ef0a90ba86f8fd0247e9c7ef">ecore_thread_run</a>(th_do, th_end, th_cancel, inf);
             threads = <a class="code" href="group__Eina__List__Group.html#ga92ec14d1a1040a361c4d8cd0ab7b0ecc" title="Appends the given data to the given linked list.">eina_list_append</a>(threads, th);
             <span class="comment">// bonus - slide the objects around all the time with an</span>
             <span class="comment">// animator that ticks off every frame.</span>
             <a class="code" href="group__Ecore__Animator__Group.html#gaa1e33b8be9117a26918823c535e429ea" title="Adds an animator to call func at every animation tick during main loop execution.">ecore_animator_add</a>(anim, o);
          }
     }

   evas_object_resize(win, 400, 400);
   <a class="code" href="group__Evas__Object__Group__Basic.html#ga9cbc13661584e49fb9d9cdab514a1eeb">evas_object_show</a>(win);

   <a class="code" href="group__Elm__General.html#gadf2553f83e6b0b9c7fbe054019a664a1">elm_run</a>();

   <span class="comment">// if some threads are still running - cancel them</span>
   <a class="code" href="group__Eina__List__Group.html#gae27a2c686a0a11693f9b06957c9bba83" title="Definition for the macro to remove each list node while having access to each node&#39;s data...">EINA_LIST_FREE</a>(threads, th) <a class="code" href="group__Ecore__Thread__Group.html#gae9b9b20e1ed53c62c51617b55aed2511">ecore_thread_cancel</a>(th);


   return 0;
}
<a class="code" href="group__Elm__General.html#ga50fe52d513f7e89c9c770afd76de7ad9">ELM_MAIN</a>()
</pre></div> </div></div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>
<hr size="1"/>
<center>
<small>Except as noted, this content - excluding the Code Examples - is licensed under <a href="http://creativecommons.org/licenses/by/3.0/legalcode" target="_blank">Creative Commons Attribution 3.0</a>
and all of the Code Examples contained herein are licensed under <a href="https://www.tizen.org/bsd-3-clause-license" target="_blank">BSD-3-Clause</a>.<br/>For details, see the <a href="https://www.tizen.org/content-license" target="_blank">Content License</a>.&nbsp;</small>
</center>
</body>
</html>
